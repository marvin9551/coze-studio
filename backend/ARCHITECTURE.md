# Coze Studio 后端项目架构文档

## 目录
- [项目概述](#项目概述)
- [技术栈](#技术栈)
- [项目结构](#项目结构)
- [核心模块详解](#核心模块详解)
  - [API层](#api层)
  - [应用层](#应用层)
  - [领域层](#领域层)
  - [基础设施层](#基础设施层)
  - [跨域层](#跨域层)
- [架构设计原则](#架构设计原则)
- [数据流向](#数据流向)
- [开发指南](#开发指南)

## 项目概述

Coze Studio 后端是一个基于领域驱动设计（DDD）和微服务架构的 Go 语言项目。它为 AI 智能体开发提供了完整的后端支持，包括工作流管理、知识库管理、插件系统、模型管理等功能。

该项目采用分层架构设计，遵循清晰的职责分离原则，使得系统具有良好的可维护性和扩展性。

## 技术栈

- **编程语言**: Go 1.24+
- **Web框架**: [Hertz](https://github.com/cloudwego/hertz) - 字节跳动开源的高性能 HTTP 框架
- **ORM框架**: [GORM](https://gorm.io/) - Go 语言的全功能 ORM 库
- **数据库**: MySQL 8.0+
- **缓存**: Redis
- **消息队列**: NSQ（可选 Kafka、RocketMQ）
- **搜索引擎**: Elasticsearch
- **对象存储**: MinIO/TOS
- **向量数据库**: Milvus
- **API文档**: Thrift
- **测试框架**: testify、gomock

## 项目结构

```
backend/
├── api/                 # API接口层
│   ├── handler/         # 请求处理器
│   ├── middleware/      # 中间件
│   ├── model/           # 数据模型（Thrift生成）
│   └── router/          # 路由配置
├── application/         # 应用服务层
├── domain/              # 领域模型层
├── infra/               # 基础设施层
├── crossdomain/         # 跨域服务层
├── conf/                # 配置文件
├── pkg/                 # 公共工具包
├── types/               # 类型定义
├── script/              # 脚本文件
├── internal/            # 内部模块
├── main.go              # 程序入口
└── go.mod               # Go模块定义
```

## 核心模块详解

### API层

API层是系统的入口，负责处理HTTP请求和响应。

#### 目录结构
```
api/
├── handler/             # 请求处理器
├── middleware/          # 中间件
├── model/               # 数据模型
└── router/              # 路由配置
```

#### 主要组件

1. **Handler**: 处理具体的HTTP请求，负责参数校验、调用应用服务、返回响应
2. **Middleware**: 提供跨切面功能，如日志记录、认证授权、请求追踪等
3. **Model**: 通过Thrift定义的数据模型，用于API请求和响应的数据结构
4. **Router**: 路由注册和管理

### 应用层

应用层负责实现业务逻辑，协调领域对象完成业务用例。

#### 目录结构
```
application/
├── app/                 # 应用相关
├── base/                # 基础设施
├── connector/           # 连接器应用服务
├── conversation/        # 对话应用服务
├── knowledge/           # 知识库应用服务
├── memory/              # 内存应用服务
├── modelmgr/            # 模型管理应用服务
├── openauth/            # 开放认证应用服务
├── plugin/              # 插件应用服务
├── prompt/              # 提示词应用服务
├── search/              # 搜索应用服务
├── shortcutcmd/         # 快捷命令应用服务
├── singleagent/         # 单智能体应用服务
├── template/            # 模板应用服务
├── upload/              # 上传应用服务
├── user/                # 用户应用服务
├── workflow/            # 工作流应用服务
└── application.go       # 应用服务初始化
```

#### 主要职责

1. 实现应用级别的业务逻辑
2. 协调领域层对象完成业务用例
3. 管理事务边界
4. 提供粗粒度的服务接口给API层

### 领域层

领域层是系统的核心，包含了业务领域的核心逻辑和规则。

#### 目录结构
```
domain/
├── agent/               # 智能体领域
├── app/                 # 应用领域
├── connector/           # 连接器领域
├── conversation/        # 对话领域
├── datacopy/            # 数据复制领域
├── knowledge/           # 知识库领域
├── memory/              # 内存领域
├── openauth/            # 开放认证领域
├── permission/          # 权限领域
├── plugin/              # 插件领域
├── prompt/              # 提示词领域
├── search/              # 搜索领域
├── shortcutcmd/         # 快捷命令领域
├── template/            # 模板领域
├── upload/              # 上传领域
├── user/                # 用户领域
└── workflow/            # 工作流领域
```

#### 核心概念

1. **实体(Entity)**: 具有唯一标识和生命周期的业务对象
2. **值对象(Value Object)**: 描述实体的特征，没有唯一标识
3. **聚合(Aggregate)**: 一组相关对象的集合，有聚合根
4. **仓储(Repository)**: 提供领域对象的持久化和查询接口
5. **领域服务(Domain Service)**: 实现跨多个实体或聚合的业务逻辑

以工作流领域为例，其结构如下：
```
workflow/
├── crossdomain/         # 跨域接口
├── entity/              # 领域实体
├── internal/            # 内部实现
├── service/             # 领域服务
├── component_interface.go
└── interface.go         # 接口定义
```

### 基础设施层

基础设施层为上层提供技术实现，如数据库访问、缓存、消息队列等。

#### 目录结构
```
infra/
├── contract/            # 契约接口
└── impl/                # 实现
```

#### 主要组件

1. **数据库访问**: 基于GORM的RDB实现
2. **缓存**: Redis实现
3. **消息队列**: NSQ/Kafka/RocketMQ实现
4. **对象存储**: MinIO/TOS实现
5. **搜索引擎**: Elasticsearch实现
6. **向量数据库**: Milvus实现
7. **模型服务**: 支持多种大模型API接入

### 跨域层

跨域层负责处理不同领域之间的服务调用。

#### 目录结构
```
crossdomain/
├── contract/            # 跨域契约接口
├── impl/                # 跨域实现
└── workflow/            # 工作流相关跨域
```

#### 主要职责

1. 解耦不同领域之间的直接依赖
2. 提供跨域服务的统一接口
3. 实现领域间的数据转换和适配

## 架构设计原则

### 1. 领域驱动设计（DDD）

项目采用DDD方法论进行设计，将系统划分为四个层次：
- **用户接口层**: API层
- **应用层**: application目录
- **领域层**: domain目录
- **基础设施层**: infra目录

### 2. 依赖倒置原则

上层模块不依赖下层模块的具体实现，而是依赖其抽象接口：
```
API层 -> 应用层 -> 领域层 -> 基础设施层
  ↓        ↓        ↓         ↑
跨域层 ←---------←----------←
```

### 3. 六边形架构

通过跨域层和基础设施层的接口设计，实现业务核心与外部依赖的解耦。

### 4. CQRS模式

在部分模块中采用CQRS（命令查询职责分离）模式，将读写操作分离以提高性能。

## 数据流向

典型的请求处理流程如下：

```
[客户端] 
    ↓ (HTTP请求)
[API Handler] 
    ↓ (调用应用服务)
[Application Service] 
    ↓ (协调领域对象)
[Domain Service/Entity] 
    ↓ (通过仓储访问数据)
[Repository] 
    ↓ (调用基础设施)
[Infrastructure Impl]
```

响应按相反方向返回。

## 开发指南

### 1. 新增业务功能步骤

1. **领域层设计**
   - 定义领域实体和值对象
   - 创建领域服务接口
   - 定义仓储接口

2. **基础设施实现**
   - 实现仓储接口
   - 实现领域服务的具体实现

3. **应用层实现**
   - 创建应用服务
   - 协调领域对象完成业务用例

4. **API层实现**
   - 定义Thrift数据模型
   - 创建请求处理器
   - 注册路由

5. **跨域层适配**
   - 如需要，创建跨域服务接口和实现

### 2. 数据库操作

项目使用GORM作为ORM框架，通过以下方式操作数据库：

1. **实体定义**: 在`domain/*/entity/`目录下定义领域实体
2. **仓储实现**: 在`domain/*/internal/repo/`目录下实现仓储
3. **数据访问**: 通过仓储接口进行数据操作

### 3. 配置管理

配置文件位于[conf/](file:///Users/marvin/sourceCode/coze-studio/backend/conf)目录下，支持多种环境配置：
- 模型配置
- 插件配置
- 提示词模板

### 4. 日志和监控

项目使用自定义的日志模块，支持不同级别的日志记录和追踪ID。

### 5. 测试

项目包含多种测试：
- 单元测试: 针对具体函数或方法的测试
- 集成测试: 针对模块间集成的测试
- Mock测试: 使用gomock进行模拟测试

通过以上架构设计，Coze Studio后端项目具备了良好的可维护性、可扩展性和可测试性，能够支撑复杂的AI智能体开发场景。